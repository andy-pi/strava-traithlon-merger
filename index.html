<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Triathlon Multi‑Sport Merger</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- PyScript -->
  <script type="module" src="https://pyscript.net/releases/2024.5.1/core.js"></script>
  <style>
    body{padding-bottom:60px}
    code.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .drag-handle{cursor:grab; user-select:none}
    .dragging{opacity:.5}
  </style>
  <script>
    // Lightweight HTML5 drag-and-drop for the table rows
    function enableDnD(tbodyId){
      const tbody = document.getElementById(tbodyId);
      let dragEl = null;
      Array.from(tbody.querySelectorAll('tr')).forEach(tr => tr.setAttribute('draggable','true'));
      tbody.addEventListener('dragstart', (e)=>{
        dragEl = e.target.closest('tr');
        if(!dragEl) return; dragEl.classList.add('dragging');
        e.dataTransfer.effectAllowed='move';
      });
      tbody.addEventListener('dragend', ()=>{ if(dragEl){ dragEl.classList.remove('dragging'); dragEl=null; } });
      tbody.addEventListener('dragover', (e)=>{
        e.preventDefault();
        const afterEl = getDragAfterElement(tbody, e.clientY);
        const cur = tbody.querySelector('.dragging');
        if(!cur) return;
        if(afterEl == null){ tbody.appendChild(cur); }
        else { tbody.insertBefore(cur, afterEl); }
      });
      function getDragAfterElement(container, y){
        const els = [...container.querySelectorAll('tr:not(.dragging)')];
        return els.reduce((closest, child)=>{
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height/2;
          if(offset < 0 && offset > closest.offset){ return {offset, element: child}; } else { return closest; }
        }, {offset: Number.NEGATIVE_INFINITY}).element;
      }
    }
  </script>
</head>
<body>
  <div class="container py-4">
    <header class="mb-4">
      <h1 class="h3 mb-1">Triathlon Multi‑Sport Merger</h1>
      <p class="text-muted mb-0">Merge Swim → (T1) → Bike → (T2) → Run into one TCX MultiSport for Strava. Runs 100% in your browser via Pyodide.</p>
    </header>

    <div class="card mb-3">
      <div class="card-header">1) Choose files</div>
      <div class="card-body">
        <div class="mb-3">
          <input type="file" id="files" class="form-control" multiple accept=".gpx,.tcx" />
          <div class="form-text">Drop in all your GPX/TCX files at once. Assign roles and drag to set priority/order.</div>
        </div>
        <button id="scan" class="btn btn-primary">Scan & Inspect</button>
        <span id="scanStatus" class="ms-2 text-muted"></span>
        <div id="tableWrap" class="mt-3" style="display:none">
          <div class="table-responsive">
            <table class="table table-sm align-middle" id="fileTable">
              <thead class="table-light">
                <tr>
                  <th style="width:36px"></th>
                  <th>File</th>
                  <th style="min-width:150px">Role</th>
                  <th>Start</th>
                  <th>End</th>
                  <th>Duration</th>
                  <th>Points</th>
                </tr>
              </thead>
              <tbody id="fileTbody"></tbody>
            </table>
          </div>
          <div class="form-text">When multiple files share the same role, the <strong>topmost</strong> (drag higher) is used.</div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header">2) Options</div>
      <div class="card-body">
        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" role="switch" id="infer" checked>
          <label class="form-check-label" for="infer">Infer missing transitions from time gaps</label>
        </div>
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" role="switch" id="compact">
          <label class="form-check-label" for="compact">Compact timeline (back‑to‑back legs; keep T1/T2 durations)</label>
        </div>
        <label class="form-label">Pool swim distance (meters) — optional</label>
        <input type="number" id="swimDist" min="0" step="1" placeholder="e.g. 1500" class="form-control" />
        <div class="form-text">If your swim has no GPS, set distance so Strava shows pace.</div>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">3) Preview</div>
          <div class="card-body">
            <button id="preview" class="btn btn-outline-secondary">Preview Timeline</button>
            <span id="previewStatus" class="ms-2 text-muted"></span>
            <pre id="previewBox" class="mt-3" style="display:none"><code id="timeline" class="mono small"></code></pre>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">4) Merge</div>
          <div class="card-body">
            <button id="merge" class="btn btn-success">Merge → Download TCX</button>
            <span id="mergeStatus" class="ms-2 text-muted"></span>
            <p class="mt-3 mb-0 text-muted">Result: <code class="mono">triathlon.tcx</code></p>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header">Developer • Tests</div>
      <div class="card-body">
        <button id="runTests" class="btn btn-outline-primary">Run unit tests</button>
        <span id="testStatus" class="ms-2 text-muted"></span>
        <pre class="mt-3"><code id="testOutput" class="mono small"></code></pre>
      </div>
    </div>

    <footer class="text-center text-muted small">© You · Client‑side; no data leaves your browser.</footer>
  </div>

  <py-config>
    packages = []
  </py-config>
  <!-- Load all logic from separate Python file -->
  <py-script src="app.py"></py-script>
  
  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
