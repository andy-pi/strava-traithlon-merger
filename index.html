<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Triathlon Multi-sport Merger</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <!-- Load PyScript runtime -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
  <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
  <py-config>
    packages = []
    [[fetch]]
    files = ["core.py", "app.py"]
  </py-config>
</head>
<body class="container py-4">
  

  <!-- Step 0 -->
  <div class="alert alert-info mb-4">
    <h1 class="mb-4">Triathlon Activity Merger</h1>
    <p>
      Many watches and fitness trackers don’t let you record a full 
      <strong>Triathlon (Swim → Bike → Run)</strong> as a single activity.  
      Instead, they save each leg separately. This tool merges those files back into 
      one clean multi-sport activity that Strava and Garmin will recognize.
    </p>
    <p>
      ✅ Runs entirely in your browser — <strong>data never leaves your computer</strong>.  <br>
      ✅ Free to use
    </p>
    <hr>
    <p class="mb-0 small">
      A tool from <a href="https://fixmymechhanger.co.uk" target="_blank" rel="noopener">Fix My Mech Hanger</a> - get your spare derailluer hangers here!
    </p>
  </div>



  <!-- Step 1 -->
  <div class="mb-4">
    <h4>1. Download activity files</h4>
    <p class="text-muted">Export your individual Swim, Bike, and Run sessions from Strava, Garmin, etc. as <code>.GPX</code>, <code>.FIT</code>, or <code>.TCX</code> files.</p>
  </div>

  <!-- Step 2 -->
  <div class="mb-4">
    <h4>2. Convert FIT → TCX (if needed)</h4>
    <p class="text-muted">
      If your files are in <code>.FIT</code> format, convert them first:  
      <a href="https://sport-calculator.com/converters/fit-to-tcx" target="_blank" rel="noopener">Sport Calculator: FIT to TCX Converter</a>
    </p>
  </div>

  <!-- Step 3 -->
  <div class="mb-4">
    <h4>3. Choose your activity files</h4>
    <input id="files" type="file" multiple class="form-control"/>
  </div>

  <!-- Step 4 -->
  <div class="mb-4">
    <h4>4. Scan & review activities</h4>
    <button id="scan" class="btn btn-primary">Scan</button>
    <div id="scanStatus" class="mt-2"></div>
    <div id="tableWrap" style="display:none" class="mt-3">
      <table class="table table-striped">
        <thead>
          <tr>
            <th></th><th>Name</th><th>Role</th><th>Start</th><th>Stop</th><th>Duration</th>
          </tr>
        </thead>
        <tbody id="fileTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Step 5 -->
  <div class="mb-4">
    <h4>5. Choose options</h4>

    <div class="form-check">
      <input id="infer" type="checkbox" class="form-check-input" checked>
      <label for="infer" class="form-check-label">Infer missing transitions</label>
      <small class="form-text text-muted">
        If you don’t upload separate T1/T2 files, the app will calculate transition times from gaps between swim → bike and bike → run.
      </small>
    </div>

    <div class="form-check">
      <input id="compact" type="checkbox" class="form-check-input">
      <label for="compact" class="form-check-label">Compact timeline (back-to-back)</label>
      <small class="form-text text-muted">
        Shifts all activities to run consecutively (no real-world gaps), but keeps transition durations.  
        Useful if you want a clean continuous session in Strava.
      </small>
    </div>

    <div class="mb-3 mt-2">
      <label for="swimDist">Swim distance (m)</label>
      <input id="swimDist" type="number" class="form-control" placeholder="e.g. 1500"/>
      <small class="form-text text-muted">
        Only needed if your swim file has no GPS points (e.g. pool swim recorded without a watch track).  
        Leave blank if the swim file already contains GPS or distance data.
      </small>
    </div>
  </div>

  <!-- Step 6 -->
  <div class="mb-4">
    <h4>6. Export merged activity</h4>
    <button id="preview" class="btn btn-secondary me-2">Preview Timeline</button>
    <button id="merge" class="btn btn-success">Export Multi-sport TCX</button>
    <div id="previewStatus" class="mt-2 text-danger"></div>
    <div id="mergeStatus" class="mt-2 text-success"></div>

    <div id="previewBox" style="display:none" class="mt-4">
      <h5>Merged Timeline</h5>
      <pre id="timeline"></pre>
    </div>
  </div>

  <!-- Drag & drop (SortableJS) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
    window.enableDnD = function(tbodyId) {
      const el = document.getElementById(tbodyId);
      if (!el) return;
      new Sortable(el, {
        handle: ".drag-handle",
        animation: 150,
        ghostClass: "table-active",
        fallbackOnBody: true,
        swapThreshold: 0.65
      });
    };
  </script>
  <style>
    .drag-handle { cursor: grab; user-select: none; }
    .drag-handle:active { cursor: grabbing; }
  </style>

  <!-- Python logic -->
  <py-script src="core.py"></py-script>
  <py-script src="app.py"></py-script>
</body>
</html>
